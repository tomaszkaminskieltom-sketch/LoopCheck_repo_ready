<!DOCTYPE html>
<html lang="pl"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>LoopCheck — Zs checker (PWA)</title>
<link rel="manifest" href="/manifest.json"><link rel="icon" href="/icon-192.png">
<meta name="theme-color" content="#ffffff">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;margin:0;background:#f7f7fb;color:#111827}
  .wrap{max-width:1000px;margin:0 auto;padding:16px 14px 80px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:12px;margin-top:12px}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:10px}
  input,select,button{font-size:14px;padding:9px 10px;border-radius:10px;border:1px solid #e5e7eb}
  button{background:#2563eb;color:#fff;border:0;box-shadow:0 4px 12px rgba(37,99,235,.25);cursor:pointer}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;margin-top:10px}
  th,td{padding:9px 8px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:#f8fafc}
  tr.ok{background:#16a34a22} tr.bad{background:#dc262622;font-weight:600}
  .muted{color:#6b7280;font-size:12px}
  @media (max-width:900px){.row{grid-template-columns:1fr 1fr}}
  @media print{.wrap{padding:0} .card{box-shadow:none} header,.actions{display:none} @page{size:A4;margin:12mm} thead{display:table-header-group}}
</style>
</head><body><div class="wrap">
<header class="card"><b>LoopCheck</b> — wersja <span id="appVersion">1.4.1</span></header>

<div class="card">
  <div class="row">
    <div><div class="muted">Adres</div><input id="addr" placeholder="np. Gliwice, ul. ..."></div>
    <div><div class="muted">Data</div><input id="date" type="date"></div>
    <div style="grid-column:span 3"><div class="muted">CSV ETI (In;Ia_0.4s;Ia_5s)</div><input id="etiCsv" type="file" accept=".csv"><div id="etiStatus" class="muted">Wbudowana tabela ETI (NEOZED)</div></div>
  </div>
</div>

<div class="card">
  <div class="muted">Nowy pomiar</div>
  <div class="row" style="margin-top:6px">
    <div><div class="muted">Miejsce</div><input id="place" placeholder="np. RG / gniazdo"></div>
    <div><div class="muted">Zs [Ω]</div><input id="zs" type="number" step="0.0001" min="0"></div>
    <div><div class="muted">Typ</div><select id="type"><option>B</option><option>C</option><option>D</option><option value="gGx4">gG ×4</option><option value="gG_ETI">gG (ETI)</option></select></div>
    <div><div class="muted">In [A]</div><input id="in" type="number" step="1" min="1"></div>
    <div><div class="muted">U₀ [V]</div><input id="u0" type="number" step="1" min="1" placeholder="230"></div>
  </div>
  <div class="row" style="margin-top:6px">
    <div><div class="muted">Ia [A] (opc.)</div><input id="ia" type="number" step="1" min="1" placeholder="auto"></div>
    <div><div class="muted">Czas ETI</div><select id="etiTime"><option value="0.2">0,2 s</option><option value="0.4" selected>0,4 s</option><option value="5">5 s</option></select></div>
    <div><button id="add" style="margin-top:18px">Dodaj</button></div>
  </div>
  <div class="muted" style="margin-top:8px">Zmax z 230 V; Prąd obliczony = U₀/Zs.</div>
</div>

<div class="card">
  <div class="actions" style="display:flex;gap:8px;justify-content:flex-end">
    <button id="exportPdf">PDF</button><button id="exportCsv">CSV</button><button id="clearAll" style="background:#111827">Wyczyść</button>
  </div>
  <table id="tbl">
    <thead><tr><th>#</th><th>Miejsce</th><th>Zs [Ω]</th><th>Typ</th><th>In [A]</th><th>U₀ [V]</th><th>Ia [A]</th><th>Zmax [Ω]</th><th>Prąd obliczony [A]</th><th>Status</th><th>Akcje</th></tr></thead>
    <tbody></tbody>
  </table>
  <div class="muted">Zmax = 230/Ia; I_obl = U₀/Zs.</div>
</div>

<script>
(function(){
  const ver='1.4.1'; document.getElementById('appVersion').textContent=ver;
  const U0_FOR_ZMAX=230;
  const embeddedETI={"2":{"0.4":16,"5":8},"4":{"0.4":31,"5":18},"6":{"0.4":49,"5":25},"10":{"0.4":74,"5":43},"16":{"0.4":115,"5":67},"20":{"0.4":145,"5":82},"25":{"0.4":202,"5":110},"32":{"0.4":235,"5":133}};
  const state={addr:'',date:new Date().toISOString().slice(0,10),rows:[],eti:embeddedETI};
  const saved=localStorage.getItem('loopcheck-data-v6'); if(saved){try{Object.assign(state,JSON.parse(saved))}catch{}}
  const $=s=>document.querySelector(s);
  $('#addr').value=state.addr||''; $('#date').value=state.date||new Date().toISOString().slice(0,10);
  const save=()=>localStorage.setItem('loopcheck-data-v6',JSON.stringify(state));
  const updateEtiStatus=()=>{$('#etiStatus').textContent='Tabela ETI: '+Object.keys(state.eti||{}).length+' pozycji';}; updateEtiStatus();
  $('#etiCsv').addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return; const t=await f.text(); const lines=t.split(/\r?\n/).filter(x=>x.trim()); const map={};
    for(const ln of lines){ const p=ln.split(/;|,\s*/).map(s=>s.trim()); if(!p[0]||p[0].toLowerCase().startsWith('in')) continue;
      const inn=parseFloat(p[0].replace(',','.')); const ia04=p[1]?parseFloat(p[1].replace(',','.')):undefined; const ia5=p[2]?parseFloat(p[2].replace(',','.')):undefined;
      if(isFinite(inn)&&(isFinite(ia04)||isFinite(ia5))) map[inn]={'0.4':ia04,'5':ia5};
    }
    state.eti=map; save(); updateEtiStatus(); alert('Tabela ETI wczytana.');
  });
  const factorFor=t=>({B:5,C:10,D:20,gGx4:4}[t]||5);
  const pickEtiIa=(inn,t)=>{const e=(state.eti||{})[inn]; if(!e) return null; return e[String(t)]||null;}
  const calc=row=>{
    let ia;
    if(row.iaManual&&row.iaManual>0){ ia=row.iaManual; }
    else if(row.type==='gG_ETI'){ const def=row.in<=32?'0.4':'5'; const tt=row.etiTime||def; ia=pickEtiIa(row.in,tt); if(!ia) ia=factorFor('gGx4')*row.in; }
    else{ ia=factorFor(row.type)*row.in; }
    const zmax=U0_FOR_ZMAX/ia;
    const icalc=row.zs? (row.u0/row.zs): null;
    return {ia,zmax,icalc,ok: row.zs<=zmax};
  };
  const fmt=(n,d=3)=> (typeof n==='number'&&isFinite(n))? n.toFixed(d):'';
  const render=()=>{
    const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
    (state.rows||[]).forEach((r,i)=>{
      const {ia,zmax,icalc,ok}=calc(r);
      const tr=document.createElement('tr'); tr.className= ok?'ok':'bad';
      tr.innerHTML='<td>'+(i+1)+'</td><td>'+ (r.place||'') +'</td><td>'+fmt(r.zs,4)+'</td><td>'+r.type+'</td><td>'+r.in+'</td><td>'+r.u0+'</td><td>'+ (ia?Math.round(ia):'') +'</td><td>'+fmt(zmax,4)+'</td><td>'+ (icalc?Math.round(icalc):'') +'</td><td>'+(ok?'OK':'NIE')+'</td><td><button class="e">Edytuj</button> <button class="d">Usuń</button></td>';
      tr.querySelector('.e').onclick=()=>editRow(i); tr.querySelector('.d').onclick=()=>{state.rows.splice(i,1); save(); render();};
      tb.appendChild(tr);
    });
  };
  const valNum = (el,name)=>{ const v=parseFloat(el.value.replace(',','.')); if(!isFinite(v)||v<=0) throw new Error('Pole "'+name+'" musi być > 0'); return v; };
  const add=()=>{
    try{
      const place=$('#place').value.trim(); const zs=valNum($('#zs'),'Zs'); const type=$('#type').value; const inn=Math.round(valNum($('#in'),'In'));
      const u0=Math.round(parseFloat($('#u0').value||'230')); let iaManual=parseFloat(($('#ia').value||'').replace(',','.')); if(!isFinite(iaManual)||iaManual<=0) iaManual=null;
      let etiTime=$('#etiTime').value; if(type==='gG_ETI'){ etiTime=inn<=32?'0.4':'5'; $('#etiTime').value=etiTime; }
      state.rows.push({place,zs,type,in:inn,u0,iaManual,etiTime}); ['place','zs','in','u0','ia'].forEach(id=>$('#'+id).value=''); $('#type').value='B'; save(); render();
    }catch(e){ alert(e.message); }
  };
  const editRow=i=>{
    const r=state.rows[i];
    const place=prompt('Miejsce:', r.place||''); if(place===null)return;
    const zs=prompt('Zs [Ω]:', r.zs); if(zs===null)return;
    const type=prompt('Typ (B/C/D/gGx4/gG_ETI):', r.type)||r.type;
    const inn=prompt('In [A]:', r.in); if(inn===null)return;
    const u0=prompt('U₀ [V]:', r.u0); if(u0===null)return;
    const ia=prompt('Ia [A] (puste = auto):', r.iaManual??''); const etiTime=prompt('Czas ETI (0.4/5):', r.etiTime||(r.in<=32?'0.4':'5'));
    try{
      const nzs=parseFloat(String(zs).replace(',','.')); if(!isFinite(nzs)||nzs<=0) throw 'Zs błędne';
      const nIn=Math.round(parseFloat(inn)); if(!isFinite(nIn)||nIn<=0) throw 'In błędne';
      const nU0=Math.round(parseFloat(u0)); if(!isFinite(nU0)||nU0<=0) throw 'U0 błędne';
      let nIa=parseFloat(String(ia).replace(',','.')); if(!isFinite(nIa)||nIa<=0) nIa=null;
      r.place=place.trim(); r.zs=nzs; r.type=/^(B|C|D|gGx4|gG_ETI)$/i.test(type)?type:r.type; r.in=nIn; r.u0=nU0; r.iaManual=nIa; r.etiTime=(etiTime==='0.4'||etiTime==='5')?etiTime:(nIn<=32?'0.4':'5');
      save(); render();
    }catch(err){ alert(err); }
  };
  $('#add').onclick=add; $('#clearAll').onclick=()=>{ if(confirm('Usunąć wszystkie?')){ state.rows=[]; save(); render(); } };
  $('#exportCsv').onclick=()=>{
    const head=['Nr','Miejsce','Zs [Ω]','Typ','In [A]','U0 [V]','Ia [A]','Zmax [Ω]','Prad obliczony [A]','Status'];
    const rows=[head.join(';')];
    (state.rows||[]).forEach((r,i)=>{const {ia,zmax,icalc,ok}=calc(r); rows.push([i+1,r.place||'', r.zs.toFixed? r.zs.toFixed(4):r.zs, r.type, r.in, r.u0, ia?Math.round(ia):'', zmax.toFixed(4), icalc?Math.round(icalc):'', ok?'OK':'NIE'].join(';'));});
    const blob=new Blob(['\ufeff'+rows.join('\n')],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pomiary.csv'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#exportPdf').onclick=()=>{window.print()};
  render();
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('/service-worker.js')); }
})();</script>
</div></body></html>
